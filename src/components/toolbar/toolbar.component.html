<div class="flex items-center px-4 h-12 border-b border-[rgb(var(--color-border-base))] bg-[rgb(var(--color-surface-muted))]">
  <!-- Default View -->
  <div class="flex items-center space-x-2">
    <!-- New Item Dropdown -->
    <div class="relative inline-block text-left">
      <button (click)="toggleNewDropdown($event)" type="button" title="New" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
        </svg>
      </button>
      
      @if(isNewDropdownOpen()) {
        <div class="absolute left-0 z-10 mt-2 w-48 origin-top-left rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu">
          <div class="py-1" role="none">
            <div (click)="onNewFolderItemClick()" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
              <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-yellow-500" viewBox="0 0 20 20" fill="currentColor">
                <path d="M2 6a2 2 0 012-2h5l2 2h5a2 2 0 012 2v6a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" />
              </svg>
              <span>New folder</span>
            </div>
            <div (click)="onNewFileItemClick()" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
               <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5 text-[rgb(var(--color-text-subtle))]" viewBox="0 0 20 20" fill="currentColor">
                  <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h8a2 2 0 012 2v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4zm2 1h8a1 1 0 011 1v10a1 1 0 01-1 1H6a1 1 0 01-1-1V6a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
              <span>New file</span>
            </div>
          </div>
        </div>
      }
    </div>
    
    <!-- Divider -->
    <div class="h-6 w-px bg-[rgb(var(--color-border-muted))]"></div>

    <!-- Action Buttons -->
    <button (click)="cutClick.emit()" [disabled]="!canCut()" title="Cut" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] disabled:opacity-50 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h4M8 7V5a2 2 0 012-2h4a2 2 0 012 2v2M8 7h8m-5 5h2m-5 3h6" />
      </svg>
    </button>
    <button (click)="copyClick.emit()" [disabled]="!canCopy()" title="Copy" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] disabled:opacity-50 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
      </svg>
    </button>
    <button (click)="pasteClick.emit()" [disabled]="!canPaste()" title="Paste" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] disabled:opacity-50 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
      </svg>
    </button>
    <button (click)="renameClick.emit()" [disabled]="!canRename()" title="Rename" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] disabled:opacity-50 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
      </svg>
    </button>
    <button (click)="shareClick.emit()" [disabled]="!canShare()" title="Share" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] disabled:opacity-50 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
      </svg>
    </button>
    <button (click)="deleteClick.emit()" [disabled]="!canDelete()" title="Delete" class="p-2 rounded-md hover:bg-[rgb(var(--color-danger-bg-hover))] disabled:opacity-50 disabled:cursor-not-allowed">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-danger-text))]/80" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
      </svg>
    </button>
    <div class="h-6 w-px bg-[rgb(var(--color-border-muted))]"></div>

    <!-- Copy to / Move to -->
    <div class="relative inline-block text-left">
      <button (click)="toggleCopyToDropdown($event)" [disabled]="!canCopyToMoveTo()" type="button" title="Copy to..." class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] text-[rgb(var(--color-text-muted))] disabled:opacity-50 disabled:cursor-not-allowed">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M8 7v4m0 0l-3-3m3 3l3-3m-6 3h6l-3-3m6 10v4m0 0l-3-3m3 3l3-3m-6 3h6l-3-3M9 7h6a2 2 0 012 2v10a2 2 0 01-2 2H9a2 2 0 01-2-2V9a2 2 0 012-2z" />
        </svg>
      </button>
      @if(isCopyToOpen()) {
        <div class="absolute left-0 z-10 mt-2 w-48 origin-top-left rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
          <div class="py-1">
            @if (folderTree(); as tree) {
              @for (child of tree.children; track child.name) {
                @if (child.type === 'folder') {
                  <app-destination-node 
                    [node]="child" 
                    [path]="[child.name]" 
                    [currentSourcePath]="currentPath()"
                    (destinationSelected)="onDestinationSelectedForCopy($event)"></app-destination-node>
                }
              }
            }
          </div>
        </div>
      }
    </div>
    <div class="relative inline-block text-left">
      <button (click)="toggleMoveToDropdown($event)" [disabled]="!canCopyToMoveTo()" type="button" title="Move to..." class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))] text-[rgb(var(--color-text-muted))] disabled:opacity-50 disabled:cursor-not-allowed">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
        </svg>
      </button>
       @if(isMoveToOpen()) {
        <div class="absolute left-0 z-10 mt-2 w-48 origin-top-left rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
          <div class="py-1">
            @if (folderTree(); as tree) {
              @for (child of tree.children; track child.name) {
                @if (child.type === 'folder') {
                  <app-destination-node 
                    [node]="child" 
                    [path]="[child.name]" 
                    [currentSourcePath]="currentPath()"
                    (destinationSelected)="onDestinationSelectedForMove($event)"></app-destination-node>
                }
              }
            }
          </div>
        </div>
      }
    </div>
  </div>

  <!-- Spacer -->
  <div class="flex-grow"></div>

  <!-- Right Side Group -->
  <div class="flex items-center space-x-2">
    <button (click)="searchClick.emit()" title="Search in Folder" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))]">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
      </svg>
    </button>
    <div class="h-6 w-px bg-[rgb(var(--color-border-muted))]"></div>
    <div class="relative">
      <input 
          type="search" 
          placeholder="Filter by name..."
          class="w-48 pl-8 pr-2 py-1 text-sm rounded-md border border-[rgb(var(--color-border-muted))] bg-[rgb(var(--color-surface))] focus:ring-1 focus:ring-[rgb(var(--color-accent-ring))] focus:outline-none"
          [value]="filterQuery()"
          (input)="onFilterInputChange($event)">
      <div class="absolute inset-y-0 left-0 pl-2 flex items-center pointer-events-none">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[rgb(var(--color-text-subtle))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2a1 1 0 01-.293.707L16 11.414V16a1 1 0 01-1 1l-3-2v-3.586L6.293 6.707A1 1 0 016 6V4z" />
        </svg>
      </div>
    </div>
    <!-- View Mode Toggles -->
    <div class="flex items-center rounded-md bg-[rgb(var(--color-surface))] p-0.5 border border-[rgb(var(--color-border-muted))]">
      <button (click)="displayModeChange.emit('grid')" title="Grid View" 
              class="p-1.5 rounded-sm transition-colors"
              [class.bg-[rgb(var(--color-accent-solid-bg))]]="displayMode() === 'grid'"
              [class.text-white]="displayMode() === 'grid'"
              [class.text-[rgb(var(--color-text-muted))]]="displayMode() !== 'grid'"
              [class.hover:bg-[rgb(var(--color-surface-hover))]]="displayMode() !== 'grid'">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2zM11 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z" />
        </svg>
      </button>
      <button (click)="displayModeChange.emit('list')" title="List View"
              class="p-1.5 rounded-sm transition-colors"
              [class.bg-[rgb(var(--color-accent-solid-bg))]]="displayMode() === 'list'"
              [class.text-white]="displayMode() === 'list'"
              [class.text-[rgb(var(--color-text-muted))]]="displayMode() !== 'list'"
              [class.hover:bg-[rgb(var(--color-surface-hover))]]="displayMode() !== 'list'">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
        </svg>
      </button>
    </div>
    <div class="h-6 w-px bg-[rgb(var(--color-border-muted))]"></div>

    <button (click)="splitViewClick.emit()" title="Split View"
            class="p-2 rounded-md transition-colors"
            [class.bg-[rgb(var(--color-accent-bg))]]="isSplitViewActive()"
            [class.text-[rgb(var(--color-accent-text))]]="isSplitViewActive()"
            [class.text-[rgb(var(--color-text-muted))]]="!isSplitViewActive()"
            [class.hover:bg-[rgb(var(--color-surface-hover))]]="!isSplitViewActive()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path d="M5 3a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2V5a2 2 0 00-2-2H5zM7 7a1 1 0 00-1 1v4a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1H7zm1-4a1 1 0 00-1-1H5a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V4zm5 4a1 1 0 00-1 1v4a1 1 0 001 1h2a1 1 0 001-1V8a1 1 0 00-1-1h-2zm1-4a1 1 0 00-1-1h-2a1 1 0 00-1 1v2a1 1 0 001 1h2a1 1 0 001-1V4z" />
      </svg>
    </button>
    <button (click)="detailPaneClick.emit()" title="Details Pane"
            class="p-2 rounded-md transition-colors"
            [class.bg-[rgb(var(--color-accent-bg))]]="isDetailPaneActive()"
            [class.text-[rgb(var(--color-accent-text))]]="isDetailPaneActive()"
            [class.text-[rgb(var(--color-text-muted))]]="!isDetailPaneActive()"
            [class.hover:bg-[rgb(var(--color-surface-hover))]]="!isDetailPaneActive()">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
      </svg>
    </button>

    <div class="h-6 w-px bg-[rgb(var(--color-border-muted))]"></div>

    <!-- Sort Dropdown -->
    <div class="relative inline-block text-left">
      <button (click)="toggleSortDropdown($event)" type="button" title="Sort" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))]">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9M3 12h9m-9 4h9m5-4v.01M18 8v.01M18 4v.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
      </button>
      @if(isSortDropdownOpen()) {
        <div class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" role="menu">
          <div class="py-1" role="none">
            @let current = currentSort();
            <div (click)="onSort('name', 'asc')" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
              <span class="w-5">
                @if(current.key === 'name' && current.direction === 'asc') { <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> }
              </span>
              <span>Name (A-Z)</span>
            </div>
            <div (click)="onSort('name', 'desc')" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
              <span class="w-5">
                @if(current.key === 'name' && current.direction === 'desc') { <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> }
              </span>
              <span>Name (Z-A)</span>
            </div>
            <div (click)="onSort('modified', 'asc')" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
              <span class="w-5">
                @if(current.key === 'modified' && current.direction === 'asc') { <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> }
              </span>
              <span>Date (Newest)</span>
            </div>
            <div (click)="onSort('modified', 'desc')" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
              <span class="w-5">
                @if(current.key === 'modified' && current.direction === 'desc') { <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> }
              </span>
              <span>Date (Oldest)</span>
            </div>
          </div>
        </div>
      }
    </div>

    <!-- Hamburger Menu -->
    <div class="relative inline-block text-left">
      <button (click)="toggleHamburgerMenu($event)" title="More options" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover))]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
      </button>
      @if(isHamburgerMenuOpen()) {
          <div class="absolute right-0 z-10 mt-2 w-48 origin-top-right rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none">
              <div class="py-1">
                  <div (click)="onThemeMenuItemClick($event)" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer">
                      <svg xmlns="http://www.w3.org/2000/svg" class="mr-3 h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 00-2 2v6a2 2 0 002 2h10a2 2 0 002-2V6a2 2 0 00-2-2H5zm0 2h10v6H5V6z" /></svg>
                      <span>Theme</span>
                  </div>
              </div>
          </div>
      }
    </div>
  </div>
</div>