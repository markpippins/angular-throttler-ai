<div class="flex flex-col h-screen font-sans antialiased text-[rgb(var(--color-text-base))] bg-[rgb(var(--color-background))]">
  <!-- Main Content -->
  <main class="flex-1 flex flex-row overflow-hidden">
    <app-sidebar 
      [folderTree]="folderTree()"
      [currentPath]="activePanePath()"
      [imageService]="defaultImageService()"
      (pathChange)="onSidebarNavigation($event)"
      (refreshTree)="loadFolderTree()"
      (loadChildren)="onLoadChildren($event)"
      (itemsMoved)="onSidebarItemsMoved($event)"
      (bookmarkDropped)="onBookmarkDroppedOnSidebar($event)"
      (serversMenuClick)="openServerProfilesDialog()">
    </app-sidebar>

    <div class="flex-1 flex flex-col overflow-hidden">
      <app-toolbar
        [canCut]="canCutCopyShareDelete()"
        [canCopy]="canCutCopyShareDelete()"
        [canCopyToMoveTo]="canCutCopyShareDelete()"
        [canPaste]="canPaste()"
        [canRename]="canRename()"
        [canShare]="canCutCopyShareDelete()"
        [canDelete]="canCutCopyShareDelete()"
        [currentSort]="activeSortCriteria()"
        [folderTree]="folderTree()"
        [currentPath]="activePanePath()"
        [isSearchView]="isSearchView()"
        [isBottomPaneVisible]="isBottomPaneVisible()"
        [displayMode]="activeDisplayMode()"
        [filterQuery]="activeFilterQuery()"
        [isSplitViewActive]="isSplitView()"
        [isDetailPaneActive]="isDetailPaneOpen()"
        (newFolderClick)="onToolbarAction('newFolder')"
        (newFileClick)="onToolbarAction('newFile')"
        (filesUploaded)="onToolbarAction('upload', $event)"
        (cutClick)="onToolbarAction('cut')"
        (copyClick)="onToolbarAction('copy')"
        (copyItemsTo)="onToolbarAction('copyTo', $event)"
        (moveItemsTo)="onToolbarAction('moveTo', $event)"
        (pasteClick)="onToolbarAction('paste')"
        (renameClick)="onToolbarAction('rename')"
        (shareClick)="onToolbarAction('share')"
        (deleteClick)="onToolbarAction('delete')"
        (sortChange)="onSortChange($event)"
        (searchClick)="openSearchDialog()"
        (closeSearchClick)="onSearchCompleted()"
        (toggleBottomPane)="onToggleBottomPane()"
        (displayModeChange)="onDisplayModeChange($event)"
        (filterChange)="onFilterChange($event)"
        (splitViewClick)="toggleSplitView()"
        (detailPaneClick)="toggleDetailPane()"
        (themeMenuClick)="openThemeMenu($event)">
      </app-toolbar>

      <div class="flex-1 flex flex-col overflow-hidden">
        <div class="flex-1 flex flex-row overflow-hidden">
          <div #paneContainer class="flex-1 flex bg-[rgb(var(--color-background))] overflow-hidden">
            <div 
              class="h-full"
              [class.flex-1]="!isSplitView()"
              [class.flex-shrink-0]="isSplitView()"
              [style.width.%]="isSplitView() ? pane1Width() : undefined">
              <app-file-explorer 
                [id]="1"
                [path]="pane1Path()"
                [isActive]="activePaneId() === 1"
                [isSplitView]="isSplitView()"
                [fileSystemProvider]="pane1Provider()"
                [imageService]="pane1ImageService()"
                [folderTree]="folderTree()"
                [refresh]="refreshPanes()"
                [toolbarAction]="toolbarAction()"
                [sortCriteria]="pane1SortCriteria()"
                [displayMode]="pane1DisplayMode()"
                [filterQuery]="pane1FilterQuery()"
                (activated)="setActivePane($event)"
                (pathChanged)="onPane1PathChanged($event)"
                (quickSearch)="executeQuickSearch(1, $event)"
                (itemSelected)="onItemSelectedInPane($event)"
                (directoryChanged)="loadFolderTree()"
                (statusChanged)="onPane1StatusChanged($event)"
                (sortChange)="onSortChange($event)"
                (saveBookmark)="onSaveBookmark($event)"
                (bookmarkDropped)="onBookmarkDroppedOnPane($event)">
              </app-file-explorer>
            </div>

            @if (isSplitView()) {
              <div 
                (mousedown)="startPaneResize($event)" 
                class="w-1.5 h-full flex-shrink-0 cursor-col-resize group flex items-center justify-center">
                <div class="w-0.5 h-full bg-[rgb(var(--color-border-base))] group-hover:bg-[rgb(var(--color-accent-ring))] transition-colors duration-200"></div>
              </div>
              <div class="flex-1 h-full">
                <app-file-explorer 
                  [id]="2"
                  [path]="pane2Path()"
                  [isActive]="activePaneId() === 2"
                  [isSplitView]="isSplitView()"
                  [fileSystemProvider]="pane2Provider()"
                  [imageService]="pane2ImageService()"
                  [folderTree]="folderTree()"
                  [refresh]="refreshPanes()"
                  [toolbarAction]="toolbarAction()"
                  [sortCriteria]="pane2SortCriteria()"
                  [displayMode]="pane2DisplayMode()"
                  [filterQuery]="pane2FilterQuery()"
                  (activated)="setActivePane($event)"
                  (pathChanged)="onPane2PathChanged($event)"
                  (quickSearch)="executeQuickSearch(2, $event)"
                  (itemSelected)="onItemSelectedInPane($event)"
                  (directoryChanged)="loadFolderTree()"
                  (statusChanged)="onPane2StatusChanged($event)"
                  (sortChange)="onSortChange($event)"
                  (saveBookmark)="onSaveBookmark($event)"
                  (bookmarkDropped)="onBookmarkDroppedOnPane($event)">
                </app-file-explorer>
              </div>
            }
          </div>
          
          @if (isDetailPaneOpen()) {
            <app-detail-pane
              [path]="activePanePath()"
              (close)="toggleDetailPane()">
            </app-detail-pane>
          }
        </div>
        
        @if (isBottomPaneVisible()) {
          <div 
            class="h-1.5 flex-shrink-0 bg-[rgb(var(--color-surface-muted))] hover:bg-[rgb(var(--color-accent-solid-bg))] cursor-row-resize transition-colors duration-150"
            (mousedown)="startBottomPaneResize($event)">
          </div>
          <div class="flex-shrink-0 overflow-hidden" [style.height.px]="bottomPaneHeight()">
            <app-bottom-pane
                [webSearchQuery]="webSearchQuery()"
                [imageSearchQuery]="imageSearchQuery()"
                [geminiSearchQuery]="geminiSearchQuery()"
                [youtubeSearchQuery]="youtubeSearchQuery()"
                [academicSearchQuery]="academicSearchQuery()"
                [fileSearchResults]="fileSearchResults()"
                [imageService]="activeImageService()"
                [activeProvider]="activeProvider()"
                [initialTabRequest]="initialTabRequest()"
                (saveBookmark)="onSaveBookmark($event)">
            </app-bottom-pane>
          </div>
        }
      </div>
    </div>
  </main>

  <!-- New Footer/Status Bar -->
  <div class="p-1 px-3 border-t border-[rgb(var(--color-border-base))] text-xs text-[rgb(var(--color-text-muted))] flex-shrink-0 bg-[rgb(var(--color-surface))]">
    @if (activePaneStatus(); as status) {
      @if (isSearchView()) {
        <span>{{ fileSearchResults()?.length ?? 0 }} item(s) found</span>
      } @else {
        @if (status.selectedItemsCount > 0) {
          <span class="mr-4">{{ status.selectedItemsCount }} item(s) selected</span>
        }
        @if (status.filteredItemsCount !== null) {
          <span>{{ status.filteredItemsCount }} of {{ status.totalItemsCount }} items</span>
        } @else {
          <span>{{ status.totalItemsCount }} items</span>
        }
      }
    } @else {
      <span>&nbsp;</span>
    }
  </div>

  @if(isThemeDropdownOpen()) {
    <div class="absolute z-50 mt-2 w-32 origin-top-left rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none" 
        [style.left.px]="themeMenuPosition().x"
        [style.top.px]="themeMenuPosition().y"
        role="menu">
      <div class="py-1" role="none">
        @for(theme of themes; track theme.id) {
          <div (click)="setTheme(theme.id)" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer" role="menuitem">
            <span class="w-5">
              @if (currentTheme() === theme.id) {
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-[rgb(var(--color-accent-text))]" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
              }
            </span>
            <span>{{ theme.name }}</span>
          </div>
        }
      </div>
    </div>
  }

  @if(isServerProfilesDialogOpen()) {
    <app-server-profiles-dialog 
      [mountedProfileIds]="mountedProfileIds()"
      [mountedProfileUsers]="mountedProfileUsers()"
      (close)="closeServerProfilesDialog()"
      (loginAndMount)="onLoginAndMount($event)"
      (unmountProfile)="onUnmountProfile($event)">
    </app-server-profiles-dialog>
  }

  @if(isSearchDialogOpen()) {
    <app-search-dialog
      (close)="closeSearchDialog()"
      (search)="executeSearch($event)">
    </app-search-dialog>
  }
</div>