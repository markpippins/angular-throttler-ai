<div class="flex flex-col h-screen antialiased text-[rgb(var(--color-text-base))] bg-[rgb(var(--color-background))]">
  <!-- Main Content -->
  <main class="flex-1 flex flex-row overflow-hidden">
    @if (isSidebarVisible()) {
      <app-sidebar 
        [folderTree]="folderTree()"
        [currentPath]="activePanePath()"
        [imageService]="imageService"
        [getProvider]="getProvider"
        [isTreeVisible]="isTreeVisible()"
        [isChatVisible]="isChatVisible()"
        [isNotesVisible]="isNotesVisible()"
        (pathChange)="onSidebarNavigation($event)"
        (refreshTree)="loadFolderTree()"
        (loadChildren)="onLoadChildren($event)"
        (itemsMoved)="onSidebarItemsMoved($event)"
        (bookmarkDropped)="onBookmarkDroppedOnSidebar($event)"
        (serversMenuClick)="openServerProfilesDialog()"
        (localConfigMenuClick)="openLocalConfigDialog()"
        (importClick)="isImportDialogOpen.set(true)"
        (exportClick)="isExportDialogOpen.set(true)"
        (renameItemInTree)="onSidebarRenameItem($event)"
        (deleteItemInTree)="onSidebarDeleteItem($event)"
        (createFolderInTree)="onSidebarNewFolder($event)"
        (createFileInTree)="onSidebarNewFile($event)"
        (connectToServer)="onConnectToServer($event)"
        (disconnectFromServer)="onDisconnectFromServer($event)"
        (editServerProfile)="onEditServerProfile($event)">
      </app-sidebar>
    }

    <div class="flex-1 flex flex-col overflow-hidden min-w-0">
      <!-- Address Bar -->
      <div class="h-12 px-4 border-b border-[rgb(var(--color-border-base))] flex items-center space-x-2 flex-shrink-0 bg-[rgb(var(--color-surface-muted))]">
        <button (click)="goUpActivePane()" [disabled]="!canGoUpActivePane()" title="Up (Backspace)" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover-subtle))] disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </button>
        <div class="flex-grow flex items-center bg-[rgb(var(--color-background))] rounded-md border border-[rgb(var(--color-border-muted))] px-2 py-1 text-sm">
          <button (click)="navigatePathActivePane(-1)" class="text-[rgb(var(--color-accent-text))] hover:underline cursor-pointer">{{ activeRootName() }}</button>
          @if (activeDisplayPath().length > 0) {
            <span class="mx-1 text-[rgb(var(--color-text-subtle))]">\</span>
          }
          @for (segment of activeDisplayPath(); track segment; let i = $index) {
            <button (click)="navigatePathActivePane(i)" class="text-[rgb(var(--color-accent-text))] hover:underline cursor-pointer">{{ segment }}</button>
            @if (!$last) {
              <span class="mx-1 text-[rgb(var(--color-text-subtle))]">\</span>
            }
          }
        </div>
        <!-- Refresh Button -->
        <button (click)="triggerRefresh()" title="Refresh (F5)" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover-subtle))]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm10.899 12.101A7.002 7.002 0 012.399 8.567a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <app-toolbar
        [canCut]="canCutCopyShareDelete()"
        [canCopy]="canCutCopyShareDelete()"
        [canCopyToMoveTo]="canCutCopyShareDelete()"
        [canPaste]="canPaste()"
        [canRename]="canRename()"
        [canShare]="canCutCopyShareDelete()"
        [canDelete]="canCutCopyShareDelete()"
        [currentSort]="activeSortCriteria()"
        [folderTree]="folderTree()"
        [currentPath]="activePanePath()"
        [displayMode]="activeDisplayMode()"
        [filterQuery]="activeFilterQuery()"
        [isSplitViewActive]="isSplitView()"
        [isDetailPaneActive]="isDetailPaneOpen()"
        [isSidebarVisible]="isSidebarVisible()"
        [isTreeVisible]="isTreeVisible()"
        [isChatVisible]="isChatVisible()"
        [isNotesVisible]="isNotesVisible()"
        [isSavedItemsVisible]="isSavedItemsVisible()"
        [isRssFeedVisible]="isRssFeedVisible()"
        [isStreamVisible]="isStreamVisible()"
        (newFolderClick)="onToolbarAction('newFolder')"
        (newFileClick)="onToolbarAction('newFile')"
        (filesUploaded)="onToolbarAction('upload', $event)"
        (cutClick)="onToolbarAction('cut')"
        (copyClick)="onToolbarAction('copy')"
        (copyItemsTo)="onToolbarAction('copyTo', $event)"
        (moveItemsTo)="onToolbarAction('moveTo', $event)"
        (pasteClick)="onToolbarAction('paste')"
        (renameClick)="onToolbarAction('rename')"
        (shareClick)="onToolbarAction('share')"
        (deleteClick)="onToolbarAction('delete')"
        (sortChange)="onSortChange($event)"
        (displayModeChange)="onDisplayModeChange($event)"
        (filterChange)="onFilterChange($event)"
        (splitViewClick)="toggleSplitView()"
        (detailPaneClick)="toggleDetailPane()"
        (themeMenuClick)="openThemeMenu($event)"
        (rssFeedsMenuClick)="openRssFeedsDialog()"
        (preferencesMenuClick)="openPreferencesDialog()"
        (toggleSidebar)="toggleSidebar()"
        (toggleTree)="toggleTree()"
        (toggleChat)="toggleChat()"
        (toggleNotes)="toggleNotes()"
        (toggleSavedItems)="toggleSavedItems()"
        (toggleRssFeed)="toggleRssFeed()"
        (toggleStream)="toggleStream()">
      </app-toolbar>

      <div class="flex-1 flex flex-row overflow-hidden">
        <div #mainContentWrapper class="flex-1 flex flex-col overflow-hidden min-w-0">
          <div class="flex-1 flex flex-row overflow-hidden">
            <div #paneContainer class="flex-1 flex bg-[rgb(var(--color-background))] overflow-hidden">
              <div 
                class="h-full"
                [class.flex-1]="!isSplitView()"
                [class.flex-shrink-0]="isSplitView()"
                [style.width.%]="isSplitView() ? pane1Width() : undefined">
                <app-file-explorer 
                  [id]="1"
                  [path]="pane1Path()"
                  [isActive]="activePaneId() === 1"
                  [isSplitView]="isSplitView()"
                  [fileSystemProvider]="pane1Provider()"
                  [imageService]="imageService"
                  [folderTree]="folderTree()"
                  [refresh]="refreshPanes()"
                  [toolbarAction]="toolbarAction()"
                  [sortCriteria]="pane1SortCriteria()"
                  [displayMode]="pane1DisplayMode()"
                  [filterQuery]="pane1FilterQuery()"
                  (activated)="setActivePane($event)"
                  (pathChanged)="onPane1PathChanged($event)"
                  (itemSelected)="onItemSelectedInPane($event)"
                  (directoryChanged)="loadFolderTree()"
                  (statusChanged)="onPane1StatusChanged($event)"
                  (sortChange)="onSortChange($event)"
                  (bookmarkDropped)="onBookmarkDroppedOnPane($event)"
                  (itemRenamed)="onPaneItemRenamed($event, pane1Path())"
                  (itemsDeleted)="onItemsDeleted($event)"
                  (itemsMoved)="onItemsMoved($event)"
                  (connectToServer)="onConnectToServer($event)"
                  (disconnectFromServer)="onDisconnectFromServer($event)"
                  (editServerProfile)="onEditServerProfile($event)"
                  (addServerProfile)="openServerProfilesDialog()"
                  (editLocalConfig)="openLocalConfigDialog()">
                </app-file-explorer>
              </div>

              @if (isSplitView()) {
                <div 
                  (mousedown)="startPaneResize($event)" 
                  class="w-1.5 h-full flex-shrink-0 cursor-col-resize group flex items-center justify-center">
                  <div class="w-0.5 h-full bg-[rgb(var(--color-border-base))] group-hover:bg-[rgb(var(--color-accent-ring))] transition-colors duration-200"></div>
                </div>
                <div class="flex-1 h-full">
                  <app-file-explorer 
                    [id]="2"
                    [path]="pane2Path()"
                    [isActive]="activePaneId() === 2"
                    [isSplitView]="isSplitView()"
                    [fileSystemProvider]="pane2Provider()"
                    [imageService]="imageService"
                    [folderTree]="folderTree()"
                    [refresh]="refreshPanes()"
                    [toolbarAction]="toolbarAction()"
                    [sortCriteria]="pane2SortCriteria()"
                    [displayMode]="pane2DisplayMode()"
                    [filterQuery]="pane2FilterQuery()"
                    (activated)="setActivePane($event)"
                    (pathChanged)="onPane2PathChanged($event)"
                    (itemSelected)="onItemSelectedInPane($event)"
                    (directoryChanged)="loadFolderTree()"
                    (statusChanged)="onPane2StatusChanged($event)"
                    (sortChange)="onSortChange($event)"
                    (bookmarkDropped)="onBookmarkDroppedOnPane($event)"
                    (itemRenamed)="onPaneItemRenamed($event, pane2Path())"
                    (itemsDeleted)="onItemsDeleted($event)"
                    (itemsMoved)="onItemsMoved($event)"
                    (connectToServer)="onConnectToServer($event)"
                    (disconnectFromServer)="onDisconnectFromServer($event)"
                    (editServerProfile)="onEditServerProfile($event)"
                    (addServerProfile)="openServerProfilesDialog()"
                    (editLocalConfig)="openLocalConfigDialog()">
                  </app-file-explorer>
                </div>
              }
            </div>
          </div>

          @if (isStreamVisible()) {
            @if (!isStreamPaneCollapsed()) {
              <!-- Resizer for Panes vs Stream -->
              <div (mousedown)="startStreamResize($event)" class="h-1.5 w-full flex-shrink-0 cursor-row-resize group flex items-center justify-center bg-[rgb(var(--color-surface-muted))] border-y border-[rgb(var(--color-border-base))]">
                <div class="h-0.5 w-full bg-[rgb(var(--color-border-muted))] group-hover:bg-[rgb(var(--color-accent-ring))] transition-colors duration-200"></div>
              </div>
            }
          
            <!-- Bottom Pane: Idea Stream -->
            <div 
              class="flex flex-col flex-shrink-0 bg-[rgb(var(--color-surface-muted))]"
              [style.height.%]="isStreamPaneCollapsed() ? undefined : streamPaneHeight()"
              [class.h-7]="isStreamPaneCollapsed()"
              [class.border-t]="isStreamPaneCollapsed()"
              [class.border-[rgb(var(--color-border-base))]]="isStreamPaneCollapsed()">
              <!-- Bottom Pane Toolbar -->
              <div class="flex-shrink-0 flex items-center justify-between p-2 border-b border-[rgb(var(--color-border-base))] bg-[rgb(var(--color-surface))] text-sm"
                  [class.h-12]="!isStreamPaneCollapsed()"
                  [class.h-7]="isStreamPaneCollapsed()">
                @if (isStreamPaneCollapsed()) {
                  <span class="text-xs text-[rgb(var(--color-text-muted))] px-2">Idea Stream</span>
                } @else {
                  <div class="flex items-center gap-2">
                    <!-- View Toggles -->
                    <div class="flex items-center rounded-md bg-[rgb(var(--color-surface))] p-0.5 border border-[rgb(var(--color-border-muted))]">
                      <button (click)="streamDisplayMode.set('grid')" title="Grid View" 
                              class="p-1.5 rounded-sm transition-colors"
                              [class.bg-[rgb(var(--color-accent-solid-bg))]]="streamDisplayMode() === 'grid'"
                              [class.text-white]="streamDisplayMode() === 'grid'"
                              [class.text-[rgb(var(--color-text-muted))]]="streamDisplayMode() !== 'grid'"
                              [class.hover:bg-[rgb(var(--color-surface-hover))]]="streamDisplayMode() !== 'grid'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2h-2zM11 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2h-2z" />
                        </svg>
                      </button>
                      <button (click)="streamDisplayMode.set('list')" title="List View"
                              class="p-1.5 rounded-sm transition-colors"
                              [class.bg-[rgb(var(--color-accent-solid-bg))]]="streamDisplayMode() === 'list'"
                              [class.text-white]="streamDisplayMode() === 'list'"
                              [class.text-[rgb(var(--color-text-muted))]]="streamDisplayMode() !== 'list'"
                              [class.hover:bg-[rgb(var(--color-surface-hover))]]="streamDisplayMode() !== 'list'">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                          <path fill-rule="evenodd" d="M3 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm0 4a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd" />
                        </svg>
                      </button>
                    </div>

                    @if (isSplitView()) {
                      <div class="flex items-center rounded-md bg-[rgb(var(--color-surface))] p-0.5 border border-[rgb(var(--color-border-muted))] text-xs font-medium">
                        <button (click)="streamSourceToggle.set('all')" title="Show from all panes" class="px-2 py-1 rounded-sm" [class.bg-[rgb(var(--color-accent-bg))]]="streamSourceToggle() === 'all'" [class.text-[rgb(var(--color-accent-text))]]="streamSourceToggle() === 'all'">All</button>
                        <button (click)="streamSourceToggle.set('active')" title="Show from active pane" class="px-2 py-1 rounded-sm" [class.bg-[rgb(var(--color-accent-bg))]]="streamSourceToggle() === 'active'" [class.text-[rgb(var(--color-accent-text))]]="streamSourceToggle() === 'active'">Active</button>
                        <button (click)="streamSourceToggle.set('left')" title="Show from left pane" class="px-2 py-1 rounded-sm" [class.bg-[rgb(var(--color-accent-bg))]]="streamSourceToggle() === 'left'" [class.text-[rgb(var(--color-accent-text))]]="streamSourceToggle() === 'left'">Left</button>
                        <button (click)="streamSourceToggle.set('right')" title="Show from right pane" class="px-2 py-1 rounded-sm" [class.bg-[rgb(var(--color-accent-bg))]]="streamSourceToggle() === 'right'" [class.text-[rgb(var(--color-accent-text))]]="streamSourceToggle() === 'right'">Right</button>
                      </div>
                    }

                    <!-- Filter Buttons -->
                    <div class="flex items-center rounded-md bg-[rgb(var(--color-surface))] p-0.5 border border-[rgb(var(--color-border-muted))] space-x-0.5">
                        <button (click)="toggleAllStreamFilters()" title="Toggle All Filters" 
                                class="p-1.5 rounded-sm transition-colors text-[rgb(var(--color-text-muted))]"
                                [class.bg-[rgb(var(--color-accent-solid-bg))]]="activeStreamFilters().size === streamFilterTypes.length"
                                [class.text-white]="activeStreamFilters().size === streamFilterTypes.length"
                                [class.hover:bg-[rgb(var(--color-surface-hover))]]="activeStreamFilters().size !== streamFilterTypes.length">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                            </svg>
                        </button>
                        <div class="w-px h-5 bg-[rgb(var(--color-border-muted))] mx-1"></div>
                        @for(filter of streamFilterTypes; track filter.type) {
                            <button (click)="toggleStreamFilter(filter.type)" [title]="filter.label"
                                    class="p-1.5 rounded-sm transition-colors"
                                    [class.bg-[rgb(var(--color-accent-bg))]]="activeStreamFilters().has(filter.type)"
                                    [class.text-[rgb(var(--color-accent-text))]]="activeStreamFilters().has(filter.type)"
                                    [class.text-[rgb(var(--color-text-muted))]]="!activeStreamFilters().has(filter.type)"
                                    [class.hover:bg-[rgb(var(--color-surface-hover))]]="!activeStreamFilters().has(filter.type)">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" [attr.d]="filter.iconPath" clip-rule="evenodd" />
                                </svg>
                            </button>
                        }
                    </div>
                    
                    <!-- Sort Dropdown -->
                    <div class="relative inline-block text-left">
                      <button (click)="toggleStreamSortDropdown($event)" type="button" title="Sort Stream" class="p-2 rounded-md text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))]">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M3 4h13M3 8h9M3 12h9m-9 4h9m5-4v.01M18 8v.01M18 4v.01M21 12a9