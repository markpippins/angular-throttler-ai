<div class="flex flex-col h-screen font-sans antialiased text-[rgb(var(--color-text-base))] bg-[rgb(var(--color-background))]">
  <!-- Main Content -->
  <main class="flex-1 flex flex-row overflow-hidden">
    @if (isSidebarVisible()) {
      <app-sidebar 
        [folderTree]="folderTree()"
        [currentPath]="activePanePath()"
        [getImageService]="getImageService"
        [getProvider]="getProvider"
        [isTreeVisible]="isTreeVisible()"
        [isChatVisible]="isChatVisible()"
        [isNotesVisible]="isNotesVisible()"
        (pathChange)="onSidebarNavigation($event)"
        (refreshTree)="loadFolderTree()"
        (loadChildren)="onLoadChildren($event)"
        (itemsMoved)="onSidebarItemsMoved($event)"
        (bookmarkDropped)="onBookmarkDroppedOnSidebar($event)"
        (serversMenuClick)="openServerProfilesDialog()"
        (localConfigMenuClick)="openLocalConfigDialog()"
        (importClick)="isImportDialogOpen.set(true)"
        (exportClick)="isExportDialogOpen.set(true)"
        (renameItemInTree)="onSidebarRenameItem($event)"
        (deleteItemInTree)="onSidebarDeleteItem($event)"
        (createFolderInTree)="onSidebarNewFolder($event)"
        (createFileInTree)="onSidebarNewFile($event)"
        (connectToServer)="onConnectToServer($event)"
        (disconnectFromServer)="onDisconnectFromServer($event)"
        (editServerProfile)="onEditServerProfile($event)">
      </app-sidebar>
    }

    <div class="flex-1 flex flex-col overflow-hidden min-w-0">
      <!-- Address Bar -->
      <div class="h-12 px-4 border-b border-[rgb(var(--color-border-base))] flex items-center space-x-2 flex-shrink-0 bg-[rgb(var(--color-surface-muted))]">
        <button (click)="goUpActivePane()" [disabled]="!canGoUpActivePane()" title="Up (Backspace)" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover-subtle))] disabled:opacity-50 disabled:cursor-not-allowed">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M12.707 5.293a1 1 0 010 1.414L9.414 10l3.293 3.293a1 1 0 01-1.414 1.414l-4-4a1 1 0 010-1.414l4-4a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
        </button>
        <div class="flex-grow flex items-center bg-[rgb(var(--color-background))] rounded-md border border-[rgb(var(--color-border-muted))] px-2 py-1 text-sm">
          <button (click)="navigatePathActivePane(-1)" class="text-[rgb(var(--color-accent-text))] hover:underline cursor-pointer">{{ activeRootName() }}</button>
          @if (activeDisplayPath().length > 0) {
            <span class="mx-1 text-[rgb(var(--color-text-subtle))]">\</span>
          }
          @for (segment of activeDisplayPath(); track segment; let i = $index) {
            <button (click)="navigatePathActivePane(i)" class="text-[rgb(var(--color-accent-text))] hover:underline cursor-pointer">{{ segment }}</button>
            @if (!$last) {
              <span class="mx-1 text-[rgb(var(--color-text-subtle))]">\</span>
            }
          }
        </div>
        <!-- Refresh Button -->
        <button (click)="triggerRefresh()" title="Refresh (F5)" class="p-2 rounded-md hover:bg-[rgb(var(--color-surface-hover-subtle))]">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-[rgb(var(--color-text-muted))]" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 010 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm10.899 12.101A7.002 7.002 0 012.399 8.567a1 1 0 011.885-.666A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101z" clip-rule="evenodd" />
          </svg>
        </button>
      </div>

      <app-toolbar
        [canCut]="canCutCopyShareDelete()"
        [canCopy]="canCutCopyShareDelete()"
        [canCopyToMoveTo]="canCutCopyShareDelete()"
        [canPaste]="canPaste()"
        [canRename]="canRename()"
        [canShare]="canCutCopyShareDelete()"
        [canDelete]="canCutCopyShareDelete()"
        [currentSort]="activeSortCriteria()"
        [folderTree]="folderTree()"
        [currentPath]="activePanePath()"
        [displayMode]="activeDisplayMode()"
        [filterQuery]="activeFilterQuery()"
        [isSplitViewActive]="isSplitView()"
        [isDetailPaneActive]="isDetailPaneOpen()"
        [isSidebarVisible]="isSidebarVisible()"
        [isTreeVisible]="isTreeVisible()"
        [isChatVisible]="isChatVisible()"
        [isNotesVisible]="isNotesVisible()"
        [isSavedItemsVisible]="isSavedItemsVisible()"
        [isRssFeedVisible]="isRssFeedVisible()"
        [isStreamVisible]="isStreamVisible()"
        (newFolderClick)="onToolbarAction('newFolder')"
        (newFileClick)="onToolbarAction('newFile')"
        (filesUploaded)="onToolbarAction('upload', $event)"
        (cutClick)="onToolbarAction('cut')"
        (copyClick)="onToolbarAction('copy')"
        (copyItemsTo)="onToolbarAction('copyTo', $event)"
        (moveItemsTo)="onToolbarAction('moveTo', $event)"
        (pasteClick)="onToolbarAction('paste')"
        (renameClick)="onToolbarAction('rename')"
        (shareClick)="onToolbarAction('share')"
        (deleteClick)="onToolbarAction('delete')"
        (sortChange)="onSortChange($event)"
        (displayModeChange)="onDisplayModeChange($event)"
        (filterChange)="onFilterChange($event)"
        (splitViewClick)="toggleSplitView()"
        (detailPaneClick)="toggleDetailPane()"
        (themeMenuClick)="openThemeMenu($event)"
        (rssFeedsMenuClick)="openRssFeedsDialog()"
        (toggleSidebar)="toggleSidebar()"
        (toggleTree)="toggleTree()"
        (toggleChat)="toggleChat()"
        (toggleNotes)="toggleNotes()"
        (toggleSavedItems)="toggleSavedItems()"
        (toggleRssFeed)="toggleRssFeed()"
        (toggleStream)="toggleStream()">
      </app-toolbar>

      <div class="flex-1 flex flex-row overflow-hidden">
        <div #paneContainer class="flex-1 flex bg-[rgb(var(--color-background))] overflow-hidden">
          <div 
            class="h-full"
            [class.flex-1]="!isSplitView()"
            [class.flex-shrink-0]="isSplitView()"
            [style.width.%]="isSplitView() ? pane1Width() : undefined">
            <app-file-explorer 
              [id]="1"
              [path]="pane1Path()"
              [isActive]="activePaneId() === 1"
              [isSplitView]="isSplitView()"
              [fileSystemProvider]="pane1Provider()"
              [imageService]="pane1ImageService()"
              [folderTree]="folderTree()"
              [refresh]="refreshPanes()"
              [toolbarAction]="toolbarAction()"
              [sortCriteria]="pane1SortCriteria()"
              [displayMode]="pane1DisplayMode()"
              [filterQuery]="pane1FilterQuery()"
              [isStreamVisible]="isStreamVisible()"
              (activated)="setActivePane($event)"
              (pathChanged)="onPane1PathChanged($event)"
              (itemSelected)="onItemSelectedInPane($event)"
              (directoryChanged)="loadFolderTree()"
              (statusChanged)="onPane1StatusChanged($event)"
              (sortChange)="onSortChange($event)"
              (saveBookmark)="onSaveBookmark($event)"
              (bookmarkDropped)="onBookmarkDroppedOnPane($event)"
              (itemRenamed)="onPaneItemRenamed($event, pane1Path())">
            </app-file-explorer>
          </div>

          @if (isSplitView()) {
            <div 
              (mousedown)="startPaneResize($event)" 
              class="w-1.5 h-full flex-shrink-0 cursor-col-resize group flex items-center justify-center">
              <div class="w-0.5 h-full bg-[rgb(var(--color-border-base))] group-hover:bg-[rgb(var(--color-accent-ring))] transition-colors duration-200"></div>
            </div>
            <div class="flex-1 h-full">
              <app-file-explorer 
                [id]="2"
                [path]="pane2Path()"
                [isActive]="activePaneId() === 2"
                [isSplitView]="isSplitView()"
                [fileSystemProvider]="pane2Provider()"
                [imageService]="pane2ImageService()"
                [folderTree]="folderTree()"
                [refresh]="refreshPanes()"
                [toolbarAction]="toolbarAction()"
                [sortCriteria]="pane2SortCriteria()"
                [displayMode]="pane2DisplayMode()"
                [filterQuery]="pane2FilterQuery()"
                [isStreamVisible]="isStreamVisible()"
                (activated)="setActivePane($event)"
                (pathChanged)="onPane2PathChanged($event)"
                (itemSelected)="onItemSelectedInPane($event)"
                (directoryChanged)="loadFolderTree()"
                (statusChanged)="onPane2StatusChanged($event)"
                (sortChange)="onSortChange($event)"
                (saveBookmark)="onSaveBookmark($event)"
                (bookmarkDropped)="onBookmarkDroppedOnPane($event)"
                (itemRenamed)="onPaneItemRenamed($event, pane2Path())">
              </app-file-explorer>
            </div>
          }
        </div>
        
        @if (isDetailPaneOpen()) {
          <app-detail-pane
            [path]="activePanePath()"
            [isSavedItemsVisible]="isSavedItemsVisible()"
            [isRssFeedVisible]="isRssFeedVisible()"
            (close)="toggleDetailPane()"
            (manageRssFeeds)="openRssFeedsDialog()">
          </app-detail-pane>
        }
      </div>
    </div>
  </main>

  <!-- Footer/Status Bar -->
  <div class="p-1 px-3 border-t border-[rgb(var(--color-border-base))] text-xs text-[rgb(var(--color-text-muted))] flex-shrink-0 bg-[rgb(var(--color-surface))]">
    @if (activePaneStatus(); as status) {
      @if (status.selectedItemsCount > 0) {
        <span class="mr-4">{{ status.selectedItemsCount }} item(s) selected</span>
      }
      @if (status.filteredItemsCount !== null) {
        <span>{{ status.filteredItemsCount }} of {{ status.totalItemsCount }} items</span>
      } @else {
        <span>{{ status.totalItemsCount }} items</span>
      }
    } @else {
      <span>&nbsp;</span>
    }
  </div>

  @if(isServerProfilesDialogOpen()) {
    <app-server-profiles-dialog 
      [mountedProfileIds]="mountedProfileIds()"
      [mountedProfileUsers]="mountedProfileUsers()"
      [initialProfileForEdit]="profileForEdit()"
      (close)="closeServerProfilesDialog()"
      (loginAndMount)="onLoginAndMount($event)"
      (profileRenamed)="onServerProfileRenamed($event)"
      (unmountProfile)="onUnmountProfile($event)">
    </app-server-profiles-dialog>
  }

  @if(isLocalConfigDialogOpen()) {
    <app-local-config-dialog 
      (close)="closeLocalConfigDialog()"
      (save)="onLocalConfigSaved($event)">
    </app-local-config-dialog>
  }
  
  @if(isRssFeedsDialogOpen()) {
    <app-rss-feeds-dialog (close)="closeRssFeedsDialog()"></app-rss-feeds-dialog>
  }

  @if(isImportDialogOpen()) {
    <app-import-dialog 
        [localSessionNode]="localSessionNode()"
        [getImageService]="getImageService"
        [getProvider]="getProvider"
        (close)="isImportDialogOpen.set(false)"
        (importData)="handleImport($event)">
    </app-import-dialog>
  }

  @if(isExportDialogOpen()) {
      <app-export-dialog
          [localSessionNode]="localSessionNode()"
          [getImageService]="getImageService"
          [getProvider]="getProvider"
          (close)="isExportDialogOpen.set(false)"
          (exportData)="handleExport($event)">
      </app-export-dialog>
  }

  @if (profileForLogin(); as profile) {
    <app-login-dialog 
      [profile]="profile"
      (close)="profileForLogin.set(null)"
      (submitLogin)="onLoginSubmittedFromSidebar($event)">
    </app-login-dialog>
  }

  <app-toasts></app-toasts>

  @if (webviewContent(); as content) {
    <app-webview-dialog
      [url]="content.url"
      [title]="content.title"
      (close)="webviewService.close()">
    </app-webview-dialog>
  }

  @if (noteDialogContent(); as content) {
    <app-note-view-dialog
      [contentSignal]="content.contentSignal"
      [title]="content.title"
      (close)="noteDialogService.close()">
    </app-note-view-dialog>
  }

  <!-- Theme Dropdown -->
  @if (isThemeDropdownOpen()) {
    <div 
        class="fixed z-20 w-36 origin-top-left rounded-md bg-[rgb(var(--color-surface-dialog))] shadow-lg ring-1 ring-black ring-opacity-5 focus:outline-none theme-menu"
        [style.top]="themeMenuPosition().top"
        [style.left]="themeMenuPosition().left"
        (click)="$event.stopPropagation()">
        <div class="py-1">
            @for(theme of themes; track theme.id) {
            <div (click)="setTheme(theme.id)" class="text-[rgb(var(--color-text-muted))] hover:bg-[rgb(var(--color-surface-hover))] flex items-center px-4 py-2 text-sm cursor-pointer">
                <span class="w-5">
                @if(currentTheme() === theme.id) { <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg> }
                </span>
                <span>{{ theme.name }}</span>
            </div>
            }
        </div>
    </div>
  }
</div>